// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  READER
}

enum MeterType {
  WATER
  ELECTRIC
}

enum ReadingFrequency {
  DAILY
  WEEKLY
  MONTHLY
  AD_HOC
}

enum NotificationType {
  NEW_ASSIGNMENT
  READING_DUE
  READING_MISSED
}

enum NotificationStatus {
  UNREAD
  READ
}

model User {
  id            String   @id @default(uuid())
  email         String   @unique
  password      String
  firstName     String
  lastName      String
  role          UserRole @default(READER)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  assignedMeters MeterAssignment[]
  readings       Reading[]
  notifications  Notification[]

  @@map("users")
}

model Location {
  id          String   @id @default(uuid())
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  meters Meter[]

  @@map("locations")
}

model Meter {
  id            String           @id @default(uuid())
  meterNumber   String           @unique
  meterType     MeterType
  locationId    String
  frequency     ReadingFrequency
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  // Relations
  location        Location          @relation(fields: [locationId], references: [id], onDelete: Cascade)
  assignments     MeterAssignment[]
  readings        Reading[]
  scheduledReadings ScheduledReading[]

  @@map("meters")
}

model MeterAssignment {
  id        String   @id @default(uuid())
  meterId   String
  userId    String
  assignedAt DateTime @default(now())
  assignedBy String? // Admin user ID who made the assignment

  // Relations
  meter Meter @relation(fields: [meterId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([meterId, userId])
  @@map("meter_assignments")
}

model ScheduledReading {
  id          String   @id @default(uuid())
  meterId     String
  scheduledDate DateTime
  dueDate     DateTime
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  meter Meter @relation(fields: [meterId], references: [id], onDelete: Cascade)

  @@map("scheduled_readings")
}

model Reading {
  id          String   @id @default(uuid())
  meterId     String
  userId      String
  value       Float
  readingDate DateTime @default(now())
  comment     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  meter Meter @relation(fields: [meterId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([meterId])
  @@index([userId])
  @@index([readingDate])
  @@map("readings")
}

model Notification {
  id        String             @id @default(uuid())
  userId    String
  type      NotificationType
  title     String
  message   String
  status    NotificationStatus @default(UNREAD)
  metadata  Json? // Additional data (meterId, readingId, etc.)
  createdAt DateTime           @default(now())
  readAt    DateTime?

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status])
  @@map("notifications")
}

